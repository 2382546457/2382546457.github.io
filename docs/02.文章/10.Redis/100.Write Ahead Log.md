---
title: Write Ahead Log
date: 2023-10-31 23:47:39
permalink: /pages/22e119/
---
>这篇文章其实更应该放在那种没有具体技术的目录中，不应该放在 MySQL 或者 Redis 任意一个目录中。

::: note 什么是 WAL？
WAL（Write Ahead Log）：**预写日志**，是关系型数据库系统很常见的一种手段，可以保证数据操作的原子性和持久性。

预写，就是在数据库改变数据之**前**（执行的命令打到磁盘之前），先将日志写了。
:::

假设一个程序在执行过程中宕机了，重启时可能需要知道当时的操作成功了还是失败了。如果使用了 WAL，程序就可以检查日志文件，并对突然宕机时计划执行的操作内容跟实际上执行的操作进行比较，在这个比较的基础上就可以决定是「撤销已经做的操作」还是「继续完成未做完的操作」还是「保持原样」。

怎么做备份？日志不就是一份备份数据吗？

再说仔细一些：

WAL ：修改并不直接写入数据库文件，而是先写入日志。如果事务失败，WAL中的记录会被删除；如果事务成功，它会在随后的某个时间被同步到数据库文件中。

优点 ：

1. 读写完全可以并发的执行，不会互相阻塞，但是写之间仍然不能并发。 一旦写入到WAL，数据可以被异步地写入实际的存储设备，例如磁盘。这允许系统将多个写操作合并并优化写入操作，从而提高性能。
2. WAL在更多情况下拥有更好的性能。
3. 磁盘 I/O 行为很容易被预测
4. 使用更少的 fsync() 操作，减少系统调用次数。

当然，各个数据库对 WAL 的实现不一样，叫法也不一样，并且不一定所有数据库都用到了 WAL。比如 Redis 就没用，它是先将命令写入，再记录日志。在 Redis 的 AOF重写 时就是先写命令，再写日志。原因如下：

1. 因为 Redis 的 AOF文件 比较大，如果先记录日志，可能会有很多错误的指令进入日志，所以先通过执行指令，执行的时候就知道这个指令有没有错误，没有错误就不用写日志。

   （那为什么MySQL不也先写数据呢？它不怕指令有错吗？人家有语法分析。）

2. Redis 基于内存，通常需要快速读写操作，使用 WAL机制 会增加 磁盘IO 开销。而Redis的设计目的就是减少磁盘开销。