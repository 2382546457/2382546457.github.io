---
title: CAS
date: 2023-07-17 02:01:44
permalink: /pages/829f0e/
---
## 1. 什么是CAS

CAS，全称 Compare and Swap，是实现并发算法时常用到的一种技术。

它包含了三个操作数：

- 内存位置
- 预期原值
- 更新值

也就是 ：比较内存中的值跟预期的旧值是否相同，如果相同就交换，不同就不交换。

使用C艹来实现就是这样的：

```c++
bool compareAndSwap(int* address, int oldValue, int newValue) {
    if (*address == oldValue) {
        *address = newValue;
    }
}
```

>当然，如果你还是不懂CAS到底是什么意思，那就来举个例子：
>
>你家里是经营小卖部的，你的妈妈告诉你：你把2号冰柜的小布丁雪糕从1块钱涨价到两块。
>
>这时你得到的信息：位置：2号冰柜；旧值：1块；新值：2块。
>
>这时你去2号冰柜看，如果旧值是1块，就成功改为2块，如果旧值不是1块，就跟妈妈说没改~

CAS是乐观锁的其中一种，可以通过 `while(true) `配合`CAS`来实现乐观锁：

```c++
for (;;) {
    bool result = compareAndSwap(&a, oldValue, newValue);
    
    // 如果改失败了或者改成功了之后的业务逻辑....
    if (result) {
        
    } 
}
```

## 2. CAS 如何实现

针对不同的操作系统，JVM 用到了不同的 CAS 实现原理，简单来讲：

- java 的 CAS 利用的的是 unsafe 这个类提供的 CAS 操作；

- unsafe 的 CAS 依赖了的是 jvm 针对不同的操作系统实现的 Atomic::cmpxchg

- Atomic::cmpxchg 的实现使用了**汇编的 CAS 操作**，并使用 cpu 硬件提供的 lock 机制保证其原子性。

**简而言之，是因为硬件予以了支持，软件层面才能做到**。

我尝试在Java源码中找到对于compareAndSwap的实现，发现不过是徒劳~  因为是c艹写的~

如下是在 Unsafe类 中定义的方法：

```java
public final native boolean compareAndSwapObject(Object var1, long var2, Object var4, Object var5);

public final native boolean compareAndSwapInt(Object var1, long var2, int var4, int var5);

public final native boolean compareAndSwapLong(Object var1, long var2, long var4, long var6);

```

都是native方法。。。

## 3. ABA问题

CAS好用，但是会造成ABA问题。什么是ABA问题？

还拿刚才的例子说。

你现在有两个兄弟，即：你的妈妈有三个孩子，你是老大。

1. 妈妈让你去把小布丁的价格从 1 块改为 2 块。
2. 妈妈觉得两块赚的还是太少，就让老二把小布丁的价格从 1 块改为 3块。
3. 妈妈觉得良心不堪，就让老三把小布丁的价格从3块改为1块。

站在妈妈的角度，她是最先让你去改，最后让老三去改，所以**妈妈期望的最终价格是1块**。

- 你去改的时候还没改呢但是中途有事离开了。

- 老二将价格改为 3 块。
- 老三将价格改为 1 块。
- 你回来了，看一下价格，是 1 块，那就把价格改为 2 块。

妈妈期望的价格是1块，结果你兄弟三人改了一通之后把它改成了两块。你们有谁改错了吗？没有，都按照吩咐正确操作了。但是就是出现了问题。这就是ABA问题。

## 4. 问题的解决

使用版本号来解决ABA问题。

还是上述的例子，只不过加了版本号。（版本号最好是从0开始递增，操作前获取版本号。）

1. 妈妈让你去把小布丁的价格从 1 块改为 2 块。
2. 妈妈觉得两块赚的还是太少，就让老二把小布丁的价格从 1 块改为 3块。
3. 妈妈觉得良心不堪，就让老三把小布丁的价格从3块改为1块。 

