<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>1. Sentinel中的一些概念与核心类解析</title>
    <meta name="generator" content="VuePress 1.9.2">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="一个基于VuePress的 知识管理&amp;博客 主题">
    <meta name="keywords" content="vuepress,theme,blog,vdoing">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.be1758fe.css" as="style"><link rel="preload" href="/assets/js/app.55b11924.js" as="script"><link rel="preload" href="/assets/js/2.73d4029d.js" as="script"><link rel="preload" href="/assets/js/63.424361b5.js" as="script"><link rel="prefetch" href="/assets/js/10.2b19092b.js"><link rel="prefetch" href="/assets/js/11.5d2d3328.js"><link rel="prefetch" href="/assets/js/12.758d1773.js"><link rel="prefetch" href="/assets/js/13.83080798.js"><link rel="prefetch" href="/assets/js/14.cad064bf.js"><link rel="prefetch" href="/assets/js/15.ce67be64.js"><link rel="prefetch" href="/assets/js/16.7c331707.js"><link rel="prefetch" href="/assets/js/17.353aa3a5.js"><link rel="prefetch" href="/assets/js/18.812e388f.js"><link rel="prefetch" href="/assets/js/19.bea0f1aa.js"><link rel="prefetch" href="/assets/js/20.ae2220ed.js"><link rel="prefetch" href="/assets/js/21.8b82ed1e.js"><link rel="prefetch" href="/assets/js/22.97d63dbe.js"><link rel="prefetch" href="/assets/js/23.79033cfd.js"><link rel="prefetch" href="/assets/js/24.96ca227f.js"><link rel="prefetch" href="/assets/js/25.90813872.js"><link rel="prefetch" href="/assets/js/26.b18aba27.js"><link rel="prefetch" href="/assets/js/27.f9995d4b.js"><link rel="prefetch" href="/assets/js/28.31b6825c.js"><link rel="prefetch" href="/assets/js/29.94237f71.js"><link rel="prefetch" href="/assets/js/3.ceab01f3.js"><link rel="prefetch" href="/assets/js/30.8269ef59.js"><link rel="prefetch" href="/assets/js/31.c18e7c44.js"><link rel="prefetch" href="/assets/js/32.06171ecb.js"><link rel="prefetch" href="/assets/js/33.a33f1b11.js"><link rel="prefetch" href="/assets/js/34.3e39f435.js"><link rel="prefetch" href="/assets/js/35.6d245714.js"><link rel="prefetch" href="/assets/js/36.c4063459.js"><link rel="prefetch" href="/assets/js/37.5bbb13b5.js"><link rel="prefetch" href="/assets/js/38.924e8c19.js"><link rel="prefetch" href="/assets/js/39.e99c2fc3.js"><link rel="prefetch" href="/assets/js/4.a6d97bd6.js"><link rel="prefetch" href="/assets/js/40.b8d5bbf4.js"><link rel="prefetch" href="/assets/js/41.ea4edc48.js"><link rel="prefetch" href="/assets/js/42.772aa8ee.js"><link rel="prefetch" href="/assets/js/43.bb7e9285.js"><link rel="prefetch" href="/assets/js/44.45df278e.js"><link rel="prefetch" href="/assets/js/45.d55cceca.js"><link rel="prefetch" href="/assets/js/46.0c8c51d9.js"><link rel="prefetch" href="/assets/js/47.0e96e931.js"><link rel="prefetch" href="/assets/js/48.7cd0eba4.js"><link rel="prefetch" href="/assets/js/49.e46e4b79.js"><link rel="prefetch" href="/assets/js/5.2729aef4.js"><link rel="prefetch" href="/assets/js/50.92ba3da6.js"><link rel="prefetch" href="/assets/js/51.0202291b.js"><link rel="prefetch" href="/assets/js/52.f92048a9.js"><link rel="prefetch" href="/assets/js/53.07ceccc9.js"><link rel="prefetch" href="/assets/js/54.4e07b215.js"><link rel="prefetch" href="/assets/js/55.2e2bb8d4.js"><link rel="prefetch" href="/assets/js/56.45e214fe.js"><link rel="prefetch" href="/assets/js/57.4ce4a530.js"><link rel="prefetch" href="/assets/js/58.f5cb3725.js"><link rel="prefetch" href="/assets/js/59.d876d40f.js"><link rel="prefetch" href="/assets/js/6.18289d2c.js"><link rel="prefetch" href="/assets/js/60.23938f5e.js"><link rel="prefetch" href="/assets/js/61.80196175.js"><link rel="prefetch" href="/assets/js/62.5f2ced9c.js"><link rel="prefetch" href="/assets/js/64.63e35c1a.js"><link rel="prefetch" href="/assets/js/65.dc44ac45.js"><link rel="prefetch" href="/assets/js/66.bac24f77.js"><link rel="prefetch" href="/assets/js/67.f2e38f54.js"><link rel="prefetch" href="/assets/js/68.8eab7a58.js"><link rel="prefetch" href="/assets/js/69.73bfbfca.js"><link rel="prefetch" href="/assets/js/7.9ce784ab.js"><link rel="prefetch" href="/assets/js/8.5a0ba8cc.js"><link rel="prefetch" href="/assets/js/9.e78313b5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.be1758fe.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/pages/259a4b/" class="nav-link">文章</a></div><div class="nav-item"><a href="/pages/1b12ed/" class="nav-link">联系我</a></div> <a href="https://github.com/2382546457" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/pages/259a4b/" class="nav-link">文章</a></div><div class="nav-item"><a href="/pages/1b12ed/" class="nav-link">联系我</a></div> <a href="https://github.com/2382546457" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/pages/259a4b/" class="sidebar-link">说明</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MySQL</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>操作系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java并发</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>框架</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>理论</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Spring</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>微服务中间件的使用</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Sentinel</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/3d8a71/" aria-current="page" class="active sidebar-link">1. Sentinel中的一些概念与核心类解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/3d8a71/#_1-资源-resourcewrapper" class="sidebar-link">1. 资源 ResourceWrapper</a></li><li class="sidebar-sub-header level2"><a href="/pages/3d8a71/#_2-节点-node" class="sidebar-link">2. 节点 Node</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/3d8a71/#_2-1-统计节点-statisticnode" class="sidebar-link">2.1 统计节点 ：StatisticNode</a></li><li class="sidebar-sub-header level3"><a href="/pages/3d8a71/#_2-2-普通节点-defaultnode" class="sidebar-link">2.2 普通节点 ：DefaultNode</a></li><li class="sidebar-sub-header level3"><a href="/pages/3d8a71/#_2-3-入口节点-entrancenode" class="sidebar-link">2.3 入口节点 ：EntranceNode</a></li><li class="sidebar-sub-header level3"><a href="/pages/3d8a71/#_2-4-全局节点-clusternode" class="sidebar-link">2.4 全局节点 ：ClusterNode</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/3d8a71/#_3-根节点-constants-root" class="sidebar-link">3. 根节点 Constants.ROOT</a></li><li class="sidebar-sub-header level2"><a href="/pages/3d8a71/#_4-entry" class="sidebar-link">4. Entry</a></li><li class="sidebar-sub-header level2"><a href="/pages/3d8a71/#_5-上下文-context" class="sidebar-link">5. 上下文 Context</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/3d8a71/#_5-1-context-的创建" class="sidebar-link">5.1 Context 的创建</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/3d8a71/#_6-插槽-processorslot" class="sidebar-link">6. 插槽 ProcessorSlot</a></li></ul></li><li><a href="/pages/51db55/" class="sidebar-link">2. Sentinel 责任链流程</a></li><li><a href="/pages/f4866d/" class="sidebar-link">3. Sentinel - NodeSelectorSlot</a></li><li><a href="/pages/df7ccb/" class="sidebar-link">4. Sentinel - ClusterBuilderSlot</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>RocketMQ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>XXL-JOB</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>踩坑</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>实习小结</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>文章</span></li><li data-v-06225672><span data-v-06225672>框架</span></li><li data-v-06225672><span data-v-06225672>Sentinel</span></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/2382546457" target="_blank" title="作者" class="beLink" data-v-06225672>何</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-11-29</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">1. Sentinel中的一些概念与核心类解析<!----></h1>  <div class="theme-vdoing-content content__default"><h2 id="_1-资源-resourcewrapper"><a href="#_1-资源-resourcewrapper" class="header-anchor">#</a> 1. 资源 ResourceWrapper</h2> <p>想要做限流、熔断，目标是谁？肯定是资源。资源可以是一个方法、一段代码、一个接口...</p> <p>Sentinel 统计的数据以资源为维度，资源使用 ResourceWrapper 表示</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ResourceWrapper</span> <span class="token punctuation">{</span>
	<span class="token comment">// 资源名</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
	<span class="token comment">// 节点类型，进入或流出</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">EntryType</span> entryType<span class="token punctuation">;</span>
    <span class="token comment">// 资源类型，比如MVC、Dubbo、grpc..</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">int</span> resourceType<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>name ：资源名</li> <li>entryType ：此资源表示的节点的类型，即流入流量还是流出流量，通俗一点说就是发起请求还是接收请求。</li> <li>resourceType ：资源类型，Sentinel 集成了很多框架，不同的资源之间还会相互调用，所以要分清楚。</li></ul> <p>EntryType 是一个枚举类 ：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">EntryType</span> <span class="token punctuation">{</span>
    <span class="token function">IN</span><span class="token punctuation">(</span><span class="token string">&quot;IN&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">OUT</span><span class="token punctuation">(</span><span class="token string">&quot;OUT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Sentinel1.8.1 支持的 resourceType 有以下几种 ：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ResourceTypeConstants</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">COMMON</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">COMMON_WEB</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">COMMON_RPC</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">COMMON_API_GATEWAY</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">COMMON_DB_SQL</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">ResourceTypeConstants</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>COMMON ：不集成任何框架</li> <li>COMMON_WEB ：集成web应用的接口</li> <li>COMMON_RPC ：rpc接口</li> <li>COMMON_API_GATEWAY ：用于 API GateWay 网关</li> <li>COMMON_DB_SQL ：数据库SQL操作</li></ul> <p>综上所述，Sentinel 中的资源可能的类型有</p> <ul><li>进入程序的web请求</li> <li>程序发出的rpc请求</li> <li>程序发出的sql操作</li> <li>.......</li></ul> <h2 id="_2-节点-node"><a href="#_2-节点-node" class="header-anchor">#</a> 2. 节点 Node</h2> <p>Sentinel 中的每一个资源都可以成为一个 Node，至于成为哪一个 Node 要看使用情况。</p> <p>Node 作为 Sentinel 中持有实时统计数据的接口，它定义了一个节点所需要提供的各项指标数据统计功能，为外部屏蔽统计数据的实现。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Node</span> <span class="token keyword">extends</span> <span class="token class-name">OccupySupport</span><span class="token punctuation">,</span> <span class="token class-name">DebugSupport</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> <span class="token function">totalRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取总的请求数</span>
    <span class="token keyword">long</span> <span class="token function">totalPass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取通过的请求总数</span>
    <span class="token keyword">long</span> <span class="token function">totalSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取成功的请求总数</span>
    <span class="token keyword">long</span> <span class="token function">blockRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取被 Sentinel 拒绝的请求总数</span>
    <span class="token keyword">long</span> <span class="token function">totalException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取异常总数</span>
    <span class="token keyword">double</span> <span class="token function">passQps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通过 QPS</span>
    <span class="token keyword">double</span> <span class="token function">blockQps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 拒绝 QPS</span>
    <span class="token keyword">double</span> <span class="token function">totalQps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 总 qps</span>
    <span class="token keyword">double</span> <span class="token function">successQps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 成功 qps</span>
    <span class="token comment">// 最大成功总数 QPS（例如秒级滑动窗口的数组大小默认配置为 2，则取数组中最大）</span>
    <span class="token keyword">double</span> <span class="token function">maxSuccessQps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">double</span> <span class="token function">exceptionQps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 异常 QPS</span>
    <span class="token keyword">double</span> <span class="token function">avgRt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 平均耗时</span>
    <span class="token keyword">double</span> <span class="token function">minRt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 最小耗时</span>
    <span class="token keyword">int</span> <span class="token function">curThreadNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 当前并发占用的线程数</span>
    <span class="token keyword">double</span> <span class="token function">previousBlockQps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 前一个时间窗口的被拒绝 qps</span>
    <span class="token keyword">double</span> <span class="token function">previousPassQps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 前一个时间窗口的通过 qps</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">MetricNode</span><span class="token punctuation">&gt;</span></span> <span class="token function">metrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MetricNode</span><span class="token punctuation">&gt;</span></span> <span class="token function">rawMetricsInMin</span><span class="token punctuation">(</span><span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> timePredicate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">addPassRequest</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 添加通过请求数</span>
    <span class="token keyword">void</span> <span class="token function">addRtAndSuccess</span><span class="token punctuation">(</span><span class="token keyword">long</span> rt<span class="token punctuation">,</span> <span class="token keyword">int</span> success<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 添加成功请求数，并且添加处理成功的耗时</span>
    <span class="token keyword">void</span> <span class="token function">increaseBlockQps</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 添加被拒绝的请求数</span>
    <span class="token keyword">void</span> <span class="token function">increaseExceptionQps</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 添加异常请求数</span>
    <span class="token keyword">void</span> <span class="token function">increaseThreadNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 自增占用线程</span>
    <span class="token keyword">void</span> <span class="token function">decreaseThreadNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 自减占用线程</span>
    <span class="token keyword">void</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 重置滑动窗口</span>
<span class="token punctuation">}</span>
</code></pre></div><p>为啥 Node 是一个接口而不是实现类？因为要将 Sentinel 中的 “节点” 按照类型区分开。</p> <p>比如有三个资源 ：a、b、c</p> <p>这三个资源有以下调用链 ：</p> <p>a -&gt; b -&gt; c</p> <p>b -&gt; c -&gt; a</p> <p>a -&gt; b -&gt; a</p> <p>在三个调用链中，同一个节点充当了不同的角色，比如第三个调用链中，a 既是入口节点也是普通节点。</p> <p>我们给它起名 ：<code>入口a</code>、<code>普通a</code></p> <p>同时如果要统计 “a” 这个资源的总访问量怎么办？难道要将全部的<code>入口a</code>、<code>普通a</code> 一个一个遍历相加？</p> <p>不，创建一个<code>全局 a</code> ，流量进入 <code>入口a</code>、<code>普通a</code>时将不仅将对应的节点流量加一，还将全局a的数据也加一</p> <p>现在有了三种节点，它们都是 Node 的子类：</p> <ul><li>入口节点 EntranceNode</li> <li>普通节点 DefaultNode</li> <li>全局节点 ClusterNode</li></ul> <p>Sentinel 将这三种节点的共同属性 ：<font color="Blue">统计数据</font>功能 抽取出来作为它们三个的父类 ：StatisticNode。关系图如下：</p> <p><img src="https://typorehwf.oss-cn-chengdu.aliyuncs.com/image-20231127200149326.png" alt="image-20231127200149326"></p> <ul><li>Node ：抽象类，提供规范</li> <li>StatisticNode ：提供了统计数据的功能。</li> <li>DefaultNode ：普通节点</li> <li>EntranceNode ：入口节点</li> <li>ClusterNode ：全局节点，一个资源只能有一个全局节点。</li></ul> <p>一个资源可能有多个入口节点或普通节点，但是只能有一个全局节点。ClusterNode 与 DefaultNode 的关系是一对多。</p> <p>接下来详细介绍各种类型的 Node</p> <h3 id="_2-1-统计节点-statisticnode"><a href="#_2-1-统计节点-statisticnode" class="header-anchor">#</a> 2.1 统计节点 ：StatisticNode</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StatisticNode</span> <span class="token keyword">implements</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span>
    <span class="token comment">// 秒级滑动窗口，2 个时间窗口大小为 500 毫秒的 Bucket</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token class-name">Metric</span> rollingCounterInSecond <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayMetric</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 分钟级滑动窗口，60 个 Bucket 数组，每个 Bucket 统计的时间窗口大小为 1 秒</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">Metric</span> rollingCounterInMinute <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayMetric</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 统计并发使用的线程数，可以根据线程数限流。</span>
    <span class="token keyword">private</span> <span class="token class-name">LongAdder</span> curThreadNum <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LongAdder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 实现了从 Node 继承过来的其他统计方法，这里列举几个简单的</span>
    
    <span class="token comment">// 一分钟内成功放心的全部请求数量</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">totalPass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> rollingCounterInMinute<span class="token punctuation">.</span><span class="token function">pass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 成功放行了一个请求，加上。</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addPassRequest</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rollingCounterInSecond<span class="token punctuation">.</span><span class="token function">addPass</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rollingCounterInMinute<span class="token punctuation">.</span><span class="token function">addPass</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 。。。。。。其他的就不放了，StatisticNode实现了Node的所有抽象方法。</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在一般情况下，Sentinel 使用滑动窗口算法统计经过每一个 Node 的资源。滑动窗口算法会在以后的文章介绍到。</p> <p>通过实现 Node 规定的方法，StatisticNode 提供了统计秒级、分钟级成功请求数、失败请求数等等功能。</p> <p>当然了，现在不会这些很正常，你只需要知道：StatisticNode 可以统计流量，所有继承它的 Node ，也就是 ClusterNode、DefaultNode、EntranceNode 也都可以统计流量。</p> <p>注意 ：StatisticNode 只提供统计数据的功能，它不表示任何资源。</p> <h3 id="_2-2-普通节点-defaultnode"><a href="#_2-2-普通节点-defaultnode" class="header-anchor">#</a> 2.2 普通节点 ：DefaultNode</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultNode</span> <span class="token keyword">extends</span> <span class="token class-name">StatisticNode</span> <span class="token punctuation">{</span>

    <span class="token comment">// 这个节点表示的资源</span>
    <span class="token keyword">private</span> <span class="token class-name">ResourceWrapper</span> id<span class="token punctuation">;</span>

    <span class="token comment">// 这个节点的全部子节点</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">&gt;</span></span> childList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
    <span class="token comment">// 该节点对应的 ClusterNode</span>
    <span class="token keyword">private</span> <span class="token class-name">ClusterNode</span> clusterNode<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">increaseBlockQps</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">increaseBlockQps</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>clusterNode<span class="token punctuation">.</span><span class="token function">increaseBlockQps</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">increaseExceptionQps</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">increaseExceptionQps</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>clusterNode<span class="token punctuation">.</span><span class="token function">increaseExceptionQps</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addRtAndSuccess</span><span class="token punctuation">(</span><span class="token keyword">long</span> rt<span class="token punctuation">,</span> <span class="token keyword">int</span> successCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">addRtAndSuccess</span><span class="token punctuation">(</span>rt<span class="token punctuation">,</span> successCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>clusterNode<span class="token punctuation">.</span><span class="token function">addRtAndSuccess</span><span class="token punctuation">(</span>rt<span class="token punctuation">,</span> successCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">increaseThreadNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">increaseThreadNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>clusterNode<span class="token punctuation">.</span><span class="token function">increaseThreadNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">decreaseThreadNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">decreaseThreadNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>clusterNode<span class="token punctuation">.</span><span class="token function">decreaseThreadNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addPassRequest</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">addPassRequest</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>clusterNode<span class="token punctuation">.</span><span class="token function">addPassRequest</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">printDefaultNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">visitTree</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>id ：这个节点表示的资源。</li> <li>childList ：这个节点的全部子节点</li> <li>clusterNode ：该节点对应的 ClusterNode。</li></ul> <p>资源与 DefaultNode 之间是一对多的关系。资源与ClusterNode之间是一对一的关系。</p> <p>一个 DefaultNode 可以有多个子节点形成如下的结构 ：</p> <p>（其实最顶端的 A 不是 DefaultNode，这里只是做一个比喻）</p> <p><img src="https://typorehwf.oss-cn-chengdu.aliyuncs.com/image-20231127202958197.png" alt="image-20231127202958197"></p> <p><font color="Blue">多个 DefaultNode 就形成了一棵树</font></p> <p>注 ：了解 Sentinel 的就能看出来这颗树还有很多缺陷，但是现在只是做一个比喻。</p> <p>同时，通过源码你可能看出来了，DefaultNode 在执行<code>放行请求</code>方法时如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addRtAndSuccess</span><span class="token punctuation">(</span><span class="token keyword">long</span> rt<span class="token punctuation">,</span> <span class="token keyword">int</span> successCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">addRtAndSuccess</span><span class="token punctuation">(</span>rt<span class="token punctuation">,</span> successCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>clusterNode<span class="token punctuation">.</span><span class="token function">addRtAndSuccess</span><span class="token punctuation">(</span>rt<span class="token punctuation">,</span> successCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>先给自己的数据记录一下，再给自己所属的 ClusterNode 记录一下，跟咱们之前说的一样。</p> <p>再次提醒 ：所有节点统计数据时都要使用从 StatisticNode 继承过来的方法。</p> <h3 id="_2-3-入口节点-entrancenode"><a href="#_2-3-入口节点-entrancenode" class="header-anchor">#</a> 2.3 入口节点 ：EntranceNode</h3> <p>入口节点没有变量，功能被 StatisticNode 实现了，变量被 DefaultNode 拥有了，EntranceNode 就特别简洁了：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EntranceNode</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultNode</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">EntranceNode</span><span class="token punctuation">(</span><span class="token class-name">ResourceWrapper</span> id<span class="token punctuation">,</span> <span class="token class-name">ClusterNode</span> clusterNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> clusterNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>EntranceNode 与 DefaultNode 的区别是重写 StatisticNode 的方法不一样。</p> <p>在这里可以剧透一下 ：EntranceNode 都是已经规定好的节点，命名方式根据集成的框架变化。比如</p> <ul><li>不集成任何框架时，EntranceNode.name = &quot;sentinel_default_context&quot;</li> <li>集成Spring MVC 时，EntranceNode.name = &quot;sentinel_spring_web_context&quot;</li></ul> <h3 id="_2-4-全局节点-clusternode"><a href="#_2-4-全局节点-clusternode" class="header-anchor">#</a> 2.4 全局节点 ：ClusterNode</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClusterNode</span> <span class="token keyword">extends</span> <span class="token class-name">StatisticNode</span> <span class="token punctuation">{</span>
	<span class="token comment">// 节点名，即资源名，其实应该使用 ResourceWrapper的，不知道这里为啥用了String</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token comment">// 资源类型</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> resourceType<span class="token punctuation">;</span>

    <span class="token comment">// 维护每个调用来源的指标数据统计数据（StatisticNode）</span>
    <span class="token comment">// 在 ClusterNode 部分会具体说。</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">StatisticNode</span><span class="token punctuation">&gt;</span></span> originCountMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
	<span class="token comment">// 控制并发修改 originCountMap 用的锁</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>name ：资源名，其实应该使用 ResourceWrapper的，不知道这里为啥用了String</li> <li>resourceType ：资源类型</li> <li>originCountMap ： 维护每个调用来源的指标数据统计数据（StatisticNode）</li> <li>lock ：控制并发修改 originCountMap 用的锁</li></ul> <p>其实它还有一个方法用来操作 originCountMap ：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Node</span> <span class="token function">getOrCreateOriginNode</span><span class="token punctuation">(</span><span class="token class-name">String</span> origin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">StatisticNode</span> statisticNode <span class="token operator">=</span> originCountMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>statisticNode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            statisticNode <span class="token operator">=</span> originCountMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>statisticNode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                statisticNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StatisticNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">StatisticNode</span><span class="token punctuation">&gt;</span></span> newMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>originCountMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                newMap<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>originCountMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
                newMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> statisticNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
                originCountMap <span class="token operator">=</span> newMap<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> statisticNode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>具体是啥意思呢，请看这个图：</p> <p><img src="https://typorehwf.oss-cn-chengdu.aliyuncs.com/image-20231130191659639.png" alt="image-20231130191659639"></p> <p>springmvc 框架中的 /hello1 通过 grpc 远程调用了 /hello2，那么在统计 /hello2 时是不是要标清楚 origin 是 hello1？</p> <p>所以就通过 origin 创建一个 hello1 节点，放在 hello2 的 ClusterNode 的 Map 中，注意，放入的节点类型为 StatisticNode，也就说明这个节点没有实际意义，只负责统计一下流量，方便做“来源限流、关联限流”。</p> <p>当用户要做 /hello1-&gt;/hello2 的来源限流时，将 hello2 的流量取出来，再将 hello2对应的 ClusterNode 中统计的 hello1 的数据取出来就可以判断是否限流了。</p> <h2 id="_3-根节点-constants-root"><a href="#_3-根节点-constants-root" class="header-anchor">#</a> 3. 根节点 Constants.ROOT</h2> <p>其实<font color="Blue">整个程序的 入口节点是固定的</font>，它存放在常量类 Constants 中。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Constants</span> <span class="token punctuation">{</span>
    <span class="token comment">// 默认context的名称</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">CONTEXT_DEFAULT_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;sentinel_default_context&quot;</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 根节点</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">DefaultNode</span> <span class="token constant">ROOT</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EntranceNode</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">StringResourceWrapper</span><span class="token punctuation">(</span><span class="token constant">ROOT_ID</span><span class="token punctuation">,</span> <span class="token class-name">EntryType</span><span class="token punctuation">.</span><span class="token constant">IN</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">ClusterNode</span><span class="token punctuation">(</span><span class="token constant">ROOT_ID</span><span class="token punctuation">,</span> <span class="token class-name">ResourceTypeConstants</span><span class="token punctuation">.</span><span class="token constant">COMMON</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 根节点对应的全局节点</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">ClusterNode</span> <span class="token constant">ENTRY_NODE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClusterNode</span><span class="token punctuation">(</span>
        <span class="token constant">TOTAL_IN_RESOURCE_NAME</span><span class="token punctuation">,</span> 
        <span class="token class-name">ResourceTypeConstants</span><span class="token punctuation">.</span><span class="token constant">COMMON</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><p><font color="Blue">根节点的<strong>第一层</strong>子节点，即 EntranceNode 也是固定的</font>，这个在前面已经剧透了</p> <p>也就是说，根节点和第一层节点都是固定的。只有从第二层节点开始才是我们的。</p> <p>（上面我说的 “第一层” 是指ROOT节点下的第一层，后续在提到 EntranceNode 时都会有 “第一层” 代称，请不要认为我说的第一层是ROOT😁）</p> <p>验证一下，我们不集成任何环境，那么 ROOT 下第一个 EntranceNode 就一定是 sentinel_default_context。</p> <p>将 <code>abc</code> 当作资源的话，<code>abc</code>就会是 sentinel_default_context 的子节点：</p> <p><img src="https://typorehwf.oss-cn-chengdu.aliyuncs.com/image-20231128104421747.png" alt="image-20231128104421747"></p> <p>（使用 sentinel-demo/sentinel-demo-basic/flow/FlowQpsDemo 测试类）</p> <p>集成了 web mvc 时，ROOT 的子节点就有俩了：</p> <p><img src="https://typorehwf.oss-cn-chengdu.aliyuncs.com/image-20231130111342368.png" alt="image-20231130111342368"></p> <p>(使用 sentinel-demo/sentinel-demo-spring-webmvc/WebMvcTestController 测试类，需要自己加上 Constants.ROOT 去 debug)</p> <p>更新一下节点树：</p> <p><img src="https://typorehwf.oss-cn-chengdu.aliyuncs.com/image-20231128104011053.png" alt="image-20231128104011053"></p> <p>这样做的好处是集成其他环境时很方便，坏处就是不好理解</p> <h2 id="_4-entry"><a href="#_4-entry" class="header-anchor">#</a> 4. Entry</h2> <p>在认识 资源 和 节点 之后就该 Entry 了，Entry是由 节点+处理器链 组成。</p> <p>Sentinel 提供的是限流、熔断功能，具体来说就是热点限流、系统限流、来源限流.... 这些功能通过责任链模式组成了一个处理器链，由于每一个资源都需要进行判断，每一个资源要的限流规则都有差别，所以每一个资源都要走一遍处理器链，Sentinel 使用 Entry 将 节点和处理器链 封装起来。</p> <p>在 Sentinel 中，处理器链也可以称为责任链。</p> <p>听起来是不是特别麻烦？确实，要做到每一个资源都进行限流确实特别麻烦。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Entry</span> <span class="token keyword">implements</span> <span class="token class-name">AutoCloseable</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建时间</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> createTime<span class="token punctuation">;</span>
    <span class="token comment">// 当前节点（DefaultNode）</span>
    <span class="token keyword">private</span> <span class="token class-name">Node</span> curNode<span class="token punctuation">;</span>
    <span class="token comment">// 来源节点</span>
    <span class="token keyword">private</span> <span class="token class-name">Node</span> originNode<span class="token punctuation">;</span>
    <span class="token comment">// 错误</span>
    <span class="token keyword">private</span> <span class="token class-name">Throwable</span> error<span class="token punctuation">;</span>
    <span class="token comment">// 资源id</span>
    <span class="token keyword">protected</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>CtEntry 是 Entry 的直接子类，后面分析源码时，我们所说 Entry 皆指 CtEntry。CtEntry 中声明的字段信息如下代码所示。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">CtEntry</span> <span class="token keyword">extends</span> <span class="token class-name">Entry</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当前 Entry 指向的父 Entry</span>
    <span class="token keyword">protected</span> <span class="token class-name">Entry</span> parent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 父 Entry 指向当前 Entry</span>
    <span class="token keyword">protected</span> <span class="token class-name">Entry</span> child <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 当前资源的 ProcessorSlotChain，责任链模式，也就是很多拦截器</span>
    <span class="token keyword">protected</span> <span class="token class-name">ProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> chain<span class="token punctuation">;</span>
    <span class="token comment">// 当前上下文</span>
    <span class="token keyword">protected</span> <span class="token class-name">Context</span> context<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>为啥 Entry 要分 parent、child 关系 ？在 Node 章节中我们介绍了，多个 DefaultNode 可以组成树，我们一次只需要统计当前一条链路的 Node，也就是一个链表，所以这个 parent 和 child 其实也可以称作 pre 和 next。</p> <blockquote><p>有一个特别需要注意的点 ：入口节点，即 EntranceNode 不会被封装为 Entry。</p></blockquote> <p><font color="blue">Entry 是一次调用形成的调用链上的节点</font>。</p> <p>这张图描述了多个 Node 的关系</p> <p><img src="https://typorehwf.oss-cn-chengdu.aliyuncs.com/image-20231127215501416.png" alt="image-20231127215501416"></p> <p>现在我们将 A -&gt; B -&gt; F 这条调用链来画一下 Entry</p> <p><img src="https://typorehwf.oss-cn-chengdu.aliyuncs.com/image-20231127223419303.png" alt="image-20231127223419303"></p> <p>（多个Entry是双向链表，多个Node是树）</p> <blockquote><p>这里请你分清 处理器链 和 调用链 的区别。</p> <ul><li><p>每一个 Entry 由 Node + 处理器链 组成</p></li> <li><p>多个 Entry 组成一个调用链</p></li></ul></blockquote> <p>Entry是啥时候创建的、怎么创建的呢？所有的资源都要封装为 Entry，然后在Entry内部的处理器链中封装为Node挂在树上。</p> <p>调用 SphU.entry(String entryName) 即可创建 Entry。如果集成了其他框架，比如SpringMVC，可以使用AOP创建。</p> <p>SphU.entry(String) 最终执行的如下方法：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Entry</span> <span class="token function">entryWithPriority</span><span class="token punctuation">(</span><span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> 
                                <span class="token keyword">int</span> count<span class="token punctuation">,</span> 
                                <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> 
                                <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BlockException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取当前上下文</span>
    <span class="token class-name">Context</span> context <span class="token operator">=</span> <span class="token class-name">ContextUtil</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token keyword">instanceof</span> <span class="token class-name">NullContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CtEntry</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 如果 Context 为空，使用默认 Context. (即name为 sentinel_default_context 的Context)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        context <span class="token operator">=</span> <span class="token class-name">InternalContextUtil</span><span class="token punctuation">.</span><span class="token function">internalEnter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">CONTEXT_DEFAULT_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">ON</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CtEntry</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 加载调用链</span>
    <span class="token class-name">ProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> chain <span class="token operator">=</span> <span class="token function">lookProcessChain</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果加载的责任链为空</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>chain <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CtEntry</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 正常情况下上面的代码都不会走到，这里会真正创建一个 CtEntry.</span>
    <span class="token class-name">Entry</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CtEntry</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> context<span class="token punctuation">,</span> count<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 开始执行整个责任链</span>
        chain<span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BlockException</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> e1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RecordLog</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Sentinel unexpected exception&quot;</span><span class="token punctuation">,</span> e1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> e<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>现在不知道Context没事，下面就是。其实直到 new CtEntry() 才是重点，new出Entry后直接执行 处理器链，处理器链中有很多个处理器，有统计资源的、限流的、熔断的...如果在处理器链的执行过程中出现被限流、熔断的异常，就会被这个 BlockException 捕获丢出。丢出之前肯定要将 Entry 销毁。</p> <blockquote><p>Entry 与 Node 的区别是啥呢？</p> <p>Node构建之后基本不会动了，除非程序重启宕机啥的。</p> <p>Entry每次请求都会构建。多个Entry就组成了一次调用链</p></blockquote> <h2 id="_5-上下文-context"><a href="#_5-上下文-context" class="header-anchor">#</a> 5. 上下文 Context</h2> <p>很多框架都有一个上下文对象，Sentinel 也不例外。Sentinel 的 ContextUtil 使用 ThreadLocal 持有 Context，Context 存储的信息包括 ：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span>
    <span class="token comment">// Context的name</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token comment">// 此次执行的入口节点，都是固定的ROOT下的第一层节点。</span>
    <span class="token keyword">private</span> <span class="token class-name">DefaultNode</span> entranceNode<span class="token punctuation">;</span>
    <span class="token comment">// 现在执行到哪个Entry了。</span>
    <span class="token keyword">private</span> <span class="token class-name">Entry</span> curEntry<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> origin <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 我们不讨论异步的情况</span>
    <span class="token comment">// private final boolean async;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>name：Context 的名称。</p></li> <li><p>entranceNode：当前调用树的入口节点，类型为 EntranceNode。这个Node比较固定，都是第一层节点。</p> <p>这个节点虽然会在 context 中，但它不会在 Entry 中，因为不参与执行，只参与统计。</p></li> <li><p>curEntry：当前 Entry（CtEntry），内含当前执行的 node</p></li> <li><p>origin：调用来源的名称，即服务消费者的名称或者服务消费者的来源 IP，取决于服务消费者是否使用 Sentinel，由 Sentinel 适配层传递过来。例如：服务提供者是 Spring MVC 应用，且服务提供者使用 Sentinel 的 Web MVC 适配，那么 Sentinel 会尝试从请求头获取”S-user”，如果服务消费者有在请求头传递这个参数，那么就能够获取到。</p></li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ContextUtil</span> <span class="token punctuation">{</span>
    <span class="token comment">// 持有 Context</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Context</span><span class="token punctuation">&gt;</span></span> contextHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 持有所有 EntranceNode，即所有第一层Node.</span>
    <span class="token comment">// 可能包含的: default、mvc、okhttp、grpc、dubbo...</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span><span class="token punctuation">&gt;</span></span> contextNameNodeMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果当前环境(mvc、dubbo、grpc) 还没有把第一层节点注册到 contextNameNodeMap，那么就加锁开始注册</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> <span class="token constant">LOCK</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里要着重说一下 contextNameNodeMap。</p> <p>ContextUtil 会将所有第一层节点存储在 contextNameNodeMap 中，从名字也可以看出来这个Map里面存储的是以 context.name 命名的 node</p> <h3 id="_5-1-context-的创建"><a href="#_5-1-context-的创建" class="header-anchor">#</a> 5.1 Context 的创建</h3> <p>当 ContextUtil 类加载的时候会执行静态代码块，初始化一个默认的EntranceNode ：sentinel_default_context 放入 contextNameNodeMap 中。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token punctuation">{</span>
    <span class="token comment">// Cache the entrance node for default context.</span>
    <span class="token function">initDefaultContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initDefaultContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> defaultContextName <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">CONTEXT_DEFAULT_NAME</span><span class="token punctuation">;</span>
    <span class="token class-name">EntranceNode</span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EntranceNode</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringResourceWrapper</span><span class="token punctuation">(</span>defaultContextName<span class="token punctuation">,</span> <span class="token class-name">EntryType</span><span class="token punctuation">.</span><span class="token constant">IN</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将此入口节点挂在 ROOT 下面。</span>
    <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">ROOT</span><span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    contextNameNodeMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>defaultContextName<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>所以在写代码的时候 contextNameNodeMap 中就已经有了一个 EntranceNode 了。当然这是题外话了，我们要说的是 Context 的创建。虽然指定了 EntranceNode 但是并未给 EntranceNode 创建 Entry，所以 EntranceNode 不会参与执行。</p> <p>ContextUtil.enter(String contextName) 可以创建一个 Context</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 显式创建 Context</span>
<span class="token class-name">ContextUtil</span><span class="token punctuation">.</span><span class="token function">enter</span><span class="token punctuation">(</span><span class="token string">&quot;sentinel_default_context&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Entry</span> entry <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
     <span class="token comment">// 创建资源对应的 entry</span>
     entry <span class="token operator">=</span> <span class="token class-name">SphU</span><span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token string">&quot;/user/get&quot;</span><span class="token punctuation">,</span> <span class="token class-name">EntryType</span><span class="token punctuation">.</span><span class="token constant">IN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">// 执行业务方法</span>
     <span class="token keyword">return</span> <span class="token function">doBusiness</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">BlockException</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">Tracer</span><span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>entry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// 销毁此entry, 会将 Context.curEntry改为entry.parent</span>
         entry<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token comment">// 销毁 Context</span>
     <span class="token class-name">ContextUtil</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Context 都是由 ContextUtil 显式创建， ContextUtil.enter(String contextName) 最终执行的逻辑 ：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// name : ContextName, Context的名称</span>
<span class="token comment">// origin : 来源，比如通过 rpc调用时，rpc服务提供者的origin就是服务调用者</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">Context</span> <span class="token function">trueEnter</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">String</span> origin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 从 ContextHolder 中取 Context，如果取不到就创建。</span>
    <span class="token comment">// 这里也是我们第一个看到 Sentinel 使用双重检查锁机制，后面还会有很多次。</span>
    <span class="token class-name">Context</span> context <span class="token operator">=</span> contextHolder<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// contextNameNodeMap 是拥有第一层节点的Map</span>
        <span class="token comment">// 比如 sentinel_default_context - EntranceNode</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span><span class="token punctuation">&gt;</span></span> localCacheNameMap <span class="token operator">=</span> contextNameNodeMap<span class="token punctuation">;</span>
        
        <span class="token comment">// 如果根据context name 无法找到第一层Node，说明当前环境(mvc、dubbo、grpc...) 还没有把第一层节点注册到 contextNameNodeMap</span>
    	<span class="token comment">// 那么就加锁开始注册</span>
        <span class="token class-name">DefaultNode</span> node <span class="token operator">=</span> localCacheNameMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 第一次检查</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果第一层节点太多了，返回一个 NullContext</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>localCacheNameMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">MAX_CONTEXT_NAME_SIZE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">setNullContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token constant">NULL_CONTEXT</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 加锁</span>
                <span class="token constant">LOCK</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    node <span class="token operator">=</span> contextNameNodeMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 第二次</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>contextNameNodeMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">MAX_CONTEXT_NAME_SIZE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token function">setNullContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span> <span class="token constant">NULL_CONTEXT</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token comment">// 这个节点肯定是入口节点</span>
                            node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EntranceNode</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringResourceWrapper</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token class-name">EntryType</span><span class="token punctuation">.</span><span class="token constant">IN</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">// 将入口节点加入到ROOT下面</span>
                            <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">ROOT</span><span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token comment">// 替换更新一下contextNameNodeMap</span>
                            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span><span class="token punctuation">&gt;</span></span> newMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>contextNameNodeMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            newMap<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>contextNameNodeMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            newMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            contextNameNodeMap <span class="token operator">=</span> newMap<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token constant">LOCK</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 上面的逻辑是创建ROOT下的第一层节点，不管是否需要创建 EntranceNode ，反正Context 是一定要的。</span>
        context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Context</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 一般来说 origin 为空，但是像被调用的rpc服务，origin就是调用来源</span>
        context<span class="token punctuation">.</span><span class="token function">setOrigin</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将此context设置到 ContextHolder中</span>
        contextHolder<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> context<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>创建Context从整体上看就两步 ：</p> <ul><li>如果这个context没有在 map中注册过，就注册一下</li> <li>创建context，指定此 Context 的 EntranceNode</li></ul> <p>重复，创建 context 时并没有给 EntranceNode 创建对应的 Entry 哦，所以 EntranceNode 不会参与执行。</p> <p>集成 springmvc框架时，Sentinel 在 HandlerInterceptor 中创建 Context ：相应的代码在 sentinel-adapter/sentinel-spring-webmvc-adapter中</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通过子类的实现，获取资源名，如 &quot;/user/{id}&quot;</span>
    <span class="token class-name">String</span> resourceName <span class="token operator">=</span> <span class="token function">getResourceName</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 对资源名进行判空啥的操作，省略掉直接进入核心代码</span>

    <span class="token comment">// 解析调用来源</span>
    <span class="token class-name">String</span> origin <span class="token operator">=</span> <span class="token function">parseOrigin</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取context name, 开始创建上下文</span>
    <span class="token class-name">String</span> contextName <span class="token operator">=</span> <span class="token string">&quot;sentinel_spring_web_context&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">ContextUtil</span><span class="token punctuation">.</span><span class="token function">enter</span><span class="token punctuation">(</span>contextName<span class="token punctuation">,</span> origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建Entry</span>
    <span class="token class-name">Entry</span> entry <span class="token operator">=</span> <span class="token class-name">SphU</span><span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span>resourceName<span class="token punctuation">,</span> <span class="token class-name">ResourceTypeConstants</span><span class="token punctuation">.</span><span class="token constant">COMMON_WEB</span><span class="token punctuation">,</span> <span class="token class-name">EntryType</span><span class="token punctuation">.</span><span class="token constant">IN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将entry放入请求域中，以便在 afterCompletion 中使用</span>
    request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>baseWebMvcConfig<span class="token punctuation">.</span><span class="token function">getRequestAttributeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>总结一下 ：</p> <ul><li>ROOT 并不参与 Context 的构建，也不参与Entry的执行。</li> <li>EntranceNode 参与 Context 的创建，但是 EntranceNode 不会参与 Entry 的执行</li> <li>Entry 是调用链</li></ul> <p>现在我们的Node树就可以变为这样 ：</p> <p><img src="https://typorehwf.oss-cn-chengdu.aliyuncs.com/image-20231130145348947.png" alt="image-20231130145348947"></p> <h2 id="_6-插槽-processorslot"><a href="#_6-插槽-processorslot" class="header-anchor">#</a> 6. 插槽 ProcessorSlot</h2> <p>ProcessorSlot 直译就是处理器插槽，是 Sentinel 实现限流降级、熔断降级、系统自适应降级等功能的切入点。Sentinel 提供的 ProcessorSlot 可以分为两类，一类是辅助完成资源指标数据统计的切入点，一类是实现降级功能的切入点。</p> <p>辅助资源指标数据统计的 ProcessorSlot：</p> <ul><li><p>NodeSelectorSlot：为当前资源创建 DefaultNode，并且将 DefaultNode 赋值给 Context.curEntry.curNode；</p> <p>如果此 DefaultNode 是当前调用链路上第二个Node（因为第一个 Node 是固定的），将该 DefaultNode 添加到的 Context.entranceNode 的子节点，否则添加到 Context.curEntry.parent 的子节点（childList）。有点抽象，我们在分析 NodeSelectorSlot 源码时再详细介绍。</p></li> <li><p>ClusterBuilderSlot：如果当前资源未创建 ClusterNode，则为资源创建 ClusterNode；将 ClusterNode 赋值给当前资源的 DefaultNode.clusterNode；如果调用来源（origin）不为空，则为调用来源创建 StatisticNode，用于实现按调用来源统计资源的指标数据，ClusterNode 持有每个调用来源的 StatisticNode。</p></li> <li><p>StatisticSlot：这是 Sentinel 最为重要的类之一，用于实现指标数据统计。先是调用后续的 ProcessorSlot#entry 判断是否放行请求，再根据判断结果进行相应的指标数据统计操作。</p></li></ul> <p>实现降级功能的 ProcessorSlot：</p> <ul><li>AuthoritySlot：实现黑白名单降级</li> <li>SystemSlot：实现系统自适应降级</li> <li>FlowSlot：实现限流降级</li> <li>DegradeSlot：实现熔断降级</li></ul> <p>Sentinel 使用责任链模式将这些插槽组成了拦截器链条，之前我们称 ProcessorSlot 为拦截器，现在要改口为插槽了</p> <ul><li>ProcessorSlot ：插槽，每一个插槽有不同的功能，比如系统限流、黑白名单限流、熔断降级。</li> <li>ProcessorSlotChain ：内含头插槽和尾插槽，将所有插槽组成插槽链执行。</li></ul> <p>关于每个 ProcessorSlot 是如何组成链表、如何实现的功能，将在后续文章详细分析。</p></div></div>  <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/12/12, 20:55:52</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/a7a70b/" class="prev">Sentinel</a></span> <span class="next"><a href="/pages/51db55/">2. Sentinel 责任链流程</a>→
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="3175543112@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/2382546457" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2023-2024
    <span>何 | MIT License</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.55b11924.js" defer></script><script src="/assets/js/2.73d4029d.js" defer></script><script src="/assets/js/63.424361b5.js" defer></script>
  </body>
</html>
