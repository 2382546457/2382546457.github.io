<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Redis 持久化机制</title>
    <meta name="generator" content="VuePress 1.9.2">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="一个基于VuePress的 知识管理&amp;博客 主题">
    <meta name="keywords" content="vuepress,theme,blog,vdoing">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.be1758fe.css" as="style"><link rel="preload" href="/assets/js/app.55b11924.js" as="script"><link rel="preload" href="/assets/js/2.73d4029d.js" as="script"><link rel="preload" href="/assets/js/17.353aa3a5.js" as="script"><link rel="prefetch" href="/assets/js/10.2b19092b.js"><link rel="prefetch" href="/assets/js/11.5d2d3328.js"><link rel="prefetch" href="/assets/js/12.758d1773.js"><link rel="prefetch" href="/assets/js/13.83080798.js"><link rel="prefetch" href="/assets/js/14.cad064bf.js"><link rel="prefetch" href="/assets/js/15.ce67be64.js"><link rel="prefetch" href="/assets/js/16.7c331707.js"><link rel="prefetch" href="/assets/js/18.812e388f.js"><link rel="prefetch" href="/assets/js/19.bea0f1aa.js"><link rel="prefetch" href="/assets/js/20.ae2220ed.js"><link rel="prefetch" href="/assets/js/21.8b82ed1e.js"><link rel="prefetch" href="/assets/js/22.97d63dbe.js"><link rel="prefetch" href="/assets/js/23.79033cfd.js"><link rel="prefetch" href="/assets/js/24.96ca227f.js"><link rel="prefetch" href="/assets/js/25.90813872.js"><link rel="prefetch" href="/assets/js/26.b18aba27.js"><link rel="prefetch" href="/assets/js/27.f9995d4b.js"><link rel="prefetch" href="/assets/js/28.31b6825c.js"><link rel="prefetch" href="/assets/js/29.94237f71.js"><link rel="prefetch" href="/assets/js/3.ceab01f3.js"><link rel="prefetch" href="/assets/js/30.8269ef59.js"><link rel="prefetch" href="/assets/js/31.c18e7c44.js"><link rel="prefetch" href="/assets/js/32.06171ecb.js"><link rel="prefetch" href="/assets/js/33.a33f1b11.js"><link rel="prefetch" href="/assets/js/34.3e39f435.js"><link rel="prefetch" href="/assets/js/35.6d245714.js"><link rel="prefetch" href="/assets/js/36.c4063459.js"><link rel="prefetch" href="/assets/js/37.5bbb13b5.js"><link rel="prefetch" href="/assets/js/38.924e8c19.js"><link rel="prefetch" href="/assets/js/39.e99c2fc3.js"><link rel="prefetch" href="/assets/js/4.a6d97bd6.js"><link rel="prefetch" href="/assets/js/40.b8d5bbf4.js"><link rel="prefetch" href="/assets/js/41.ea4edc48.js"><link rel="prefetch" href="/assets/js/42.772aa8ee.js"><link rel="prefetch" href="/assets/js/43.bb7e9285.js"><link rel="prefetch" href="/assets/js/44.45df278e.js"><link rel="prefetch" href="/assets/js/45.d55cceca.js"><link rel="prefetch" href="/assets/js/46.0c8c51d9.js"><link rel="prefetch" href="/assets/js/47.0e96e931.js"><link rel="prefetch" href="/assets/js/48.7cd0eba4.js"><link rel="prefetch" href="/assets/js/49.e46e4b79.js"><link rel="prefetch" href="/assets/js/5.2729aef4.js"><link rel="prefetch" href="/assets/js/50.92ba3da6.js"><link rel="prefetch" href="/assets/js/51.0202291b.js"><link rel="prefetch" href="/assets/js/52.f92048a9.js"><link rel="prefetch" href="/assets/js/53.07ceccc9.js"><link rel="prefetch" href="/assets/js/54.4e07b215.js"><link rel="prefetch" href="/assets/js/55.2e2bb8d4.js"><link rel="prefetch" href="/assets/js/56.45e214fe.js"><link rel="prefetch" href="/assets/js/57.4ce4a530.js"><link rel="prefetch" href="/assets/js/58.f5cb3725.js"><link rel="prefetch" href="/assets/js/59.d876d40f.js"><link rel="prefetch" href="/assets/js/6.18289d2c.js"><link rel="prefetch" href="/assets/js/60.23938f5e.js"><link rel="prefetch" href="/assets/js/61.80196175.js"><link rel="prefetch" href="/assets/js/62.5f2ced9c.js"><link rel="prefetch" href="/assets/js/63.424361b5.js"><link rel="prefetch" href="/assets/js/64.63e35c1a.js"><link rel="prefetch" href="/assets/js/65.dc44ac45.js"><link rel="prefetch" href="/assets/js/66.bac24f77.js"><link rel="prefetch" href="/assets/js/67.f2e38f54.js"><link rel="prefetch" href="/assets/js/68.8eab7a58.js"><link rel="prefetch" href="/assets/js/69.73bfbfca.js"><link rel="prefetch" href="/assets/js/7.9ce784ab.js"><link rel="prefetch" href="/assets/js/8.5a0ba8cc.js"><link rel="prefetch" href="/assets/js/9.e78313b5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.be1758fe.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/pages/259a4b/" class="nav-link">文章</a></div><div class="nav-item"><a href="/pages/1b12ed/" class="nav-link">联系我</a></div> <a href="https://github.com/2382546457" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/pages/259a4b/" class="nav-link">文章</a></div><div class="nav-item"><a href="/pages/1b12ed/" class="nav-link">联系我</a></div> <a href="https://github.com/2382546457" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/pages/259a4b/" class="sidebar-link">说明</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MySQL</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Redis</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/77c4c7/" class="sidebar-link">Redis数据结构与数据类型</a></li><li><a href="/pages/4e0b96/" aria-current="page" class="active sidebar-link">Redis 持久化机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/4e0b96/#_1-概述" class="sidebar-link">1. 概述</a></li><li class="sidebar-sub-header level2"><a href="/pages/4e0b96/#_2-rdb" class="sidebar-link">2. RDB</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/4e0b96/#_2-1-手动快照" class="sidebar-link">2.1 手动快照</a></li><li class="sidebar-sub-header level3"><a href="/pages/4e0b96/#_2-2-自动快照" class="sidebar-link">2.2 自动快照</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/4e0b96/#_3-aof" class="sidebar-link">3. AOF</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/4e0b96/#_3-1-aof-机制" class="sidebar-link">3.1 AOF 机制</a></li><li class="sidebar-sub-header level3"><a href="/pages/4e0b96/#_3-2-aof-文件的重写" class="sidebar-link">3.2 AOF 文件的重写</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/4e0b96/#_4-混合型持久化" class="sidebar-link">4. 混合型持久化</a></li><li class="sidebar-sub-header level2"><a href="/pages/4e0b96/#_5-总结" class="sidebar-link">5. 总结</a></li></ul></li><li><a href="/pages/73749d/" class="sidebar-link">Redis内存回收</a></li><li><a href="/pages/db45e7/" class="sidebar-link">Redis主从集群原理</a></li><li><a href="/pages/3743cc/" class="sidebar-link">Redis哨兵集群</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>操作系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java并发</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>踩坑</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>实习小结</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>文章</span></li><li data-v-06225672><span data-v-06225672>Redis</span></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/2382546457" target="_blank" title="作者" class="beLink" data-v-06225672>何</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-06-11</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">Redis 持久化机制<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="redis-持久化机制"><a href="#redis-持久化机制" class="header-anchor">#</a> Redis 持久化机制</h1> <h2 id="_1-概述"><a href="#_1-概述" class="header-anchor">#</a> 1. 概述</h2> <p><code>Redis</code> ​为了保证性能，会将所有数据放在内存中，那么万一 Redis 宕机，数据岂不是全部丢失了？</p> <p>不要怕，Redis 自然想到了这一点，它提供了三种持久化机制将内存中的数据持久化到磁盘中。</p> <ol><li><p><strong>RDB</strong></p> <p>快照方式持久化（snapshot），快照在 Linux 就已经学过，保存所有数据的状态，下次开机直接按照这个状态恢复。</p> <p>因为保存的快照是以.rdb 结尾的文件，故称此方式为 RDB 持久化方式。</p></li> <li><p><strong>AOF</strong></p> <p>（append only file）只追加日志文件，记录 Redis 所有写命令，下次开机将这些命令全部执行，即可恢复数据。</p></li> <li><p><strong>混合型持久化</strong></p> <p>RDB 虽然快，但是数据丢失问题较为严重；AOF 虽然能保证数据安全，但是执行所有命令需要很长时间。</p> <p>所以 Redis4.x 以后，将两种方式结合，RDB 文件的内容放在 AOF 文件中，以.aof 文件的形式存储。在恢复数据时，先加载 rdb 的内容，再执行 aof 的内容。缺点是两种格式混合在一起难以阅读。</p></li></ol> <p>==需要注意的是，不论是哪种方式，都无法保证数据的绝对安全。==</p> <h2 id="_2-rdb"><a href="#_2-rdb" class="header-anchor">#</a> 2. RDB</h2> <p>snapshot 想必大家已经不陌生了，Linux 已经接触过这个机制：==保存现在的状态，随时准备恢复。==</p> <p>拍摄的快照以**.rdb** 的形式保存在磁盘中。</p> <p>假如在 Redis 宕机之前拍摄的快照为：</p> <p><img src="https://typorehwf.oss-cn-chengdu.aliyuncs.com/image-20230102101206-yrbh2d0.png" alt="image"></p> <p>那么下次开机就可以即将这两个数据恢复。</p> <p>Redis 提供了两种拍摄快照的方式 ：自动、手动。其中手动拍摄快照有两个命令：save、bgsave</p> <p><img src="https://typorehwf.oss-cn-chengdu.aliyuncs.com/image-20230102101717-g9cnz1r.png" alt="image"></p> <h3 id="_2-1-手动快照"><a href="#_2-1-手动快照" class="header-anchor">#</a> 2.1 手动快照</h3> <ol><li><p><strong>save</strong></p> <p>由主进程完成快照的拍摄，持久化过程中其他命令阻塞。</p> <p><img src="https://typorehwf.oss-cn-chengdu.aliyuncs.com/image-20230102105300-zs34lcz.png" alt="image"></p></li> <li><p><strong>bgsave</strong></p> <p>background save，主线程 fork 出一个子进程，由这个子进程完成持久化。</p> <p><img src="https://typorehwf.oss-cn-chengdu.aliyuncs.com/image-20230102105321-usbmqdu.png" alt="image"></p></li></ol> <blockquote><p>fork ：</p> <p>当一个进程创建子进程时，底层的操作系统会创建该进程的副本，在类 unix 系统中创建子进程的操作会进行优化：在刚开始的时候，父子进程共享相同内存，直到父进程/子进程对内存进行写操作后结束共享，各用各的。</p></blockquote> <h3 id="_2-2-自动快照"><a href="#_2-2-自动快照" class="header-anchor">#</a> 2.2 自动快照</h3> <p>在 redis.conf 配置文件中存在，参数如下:（版本不同，默认参数不同）</p> <div class="language-vim extra-class"><pre class="language-vim"><code>#   <span class="token operator">*</span> After <span class="token number">3600</span> seconds <span class="token punctuation">(</span>an hour<span class="token punctuation">)</span> <span class="token keyword">if</span> at least <span class="token number">1</span> <span class="token builtin">key</span> changed
#   <span class="token operator">*</span> After <span class="token number">300</span> seconds <span class="token punctuation">(</span><span class="token number">5</span> minutes<span class="token punctuation">)</span> <span class="token keyword">if</span> at least <span class="token number">100</span> keys changed
#   <span class="token operator">*</span> After <span class="token number">60</span> seconds <span class="token keyword">if</span> at least <span class="token number">10000</span> keys changed

# save <span class="token number">3600</span> <span class="token number">1</span>
# save <span class="token number">300</span> <span class="token number">100</span>
# save <span class="token number">60</span> <span class="token number">10000</span>
</code></pre></div><p>解释 ：</p> <p>1h 内有一个键被改变会触发快照拍摄。</p> <p>5mins 内有 100 个键被改变会触发快照拍摄。</p> <p>1min 内有 10000 个键被改变会触发快照拍摄。</p> <p>这些快照的拍摄方式都是 bgsave。</p> <p><strong>优点 ：</strong></p> <ul><li><p>rdb 文件的加载速度特别快，远超 aof。</p></li> <li><p>使用单独子进程来进行持久化，主进程不会进行任何 IO 操作。</p></li></ul> <p><strong>缺点 ：</strong></p> <ul><li><p>容易造成数据丢失。</p></li> <li><p>每次拍快照都要创建子进程，浪费资源.。</p></li></ul> <h2 id="_3-aof"><a href="#_3-aof" class="header-anchor">#</a> 3. AOF</h2> <p>这种机制可以将所有客户端执行的写命令记录到日志文件中，<code>AOF</code> ​持久化会将被执行的写命令写到 AOF 文件末尾，以此来记录数据发生变化的全过程，因此只要 Redis 从头到尾执行一遍 AOF 文件中的命令，就可以恢复之前的数据。</p> <h3 id="_3-1-aof-机制"><a href="#_3-1-aof-机制" class="header-anchor">#</a> 3.1 AOF 机制</h3> <p><code>RDB</code> ​是间隔一段时间进行持久化，如果持久化之间的时间内发生故障，会出现数据丢失。而 <code>AOF</code> ​持久化方式能很好的解决 <code>RDB</code> ​持久化方式造成的数据丢失，<code>AOF</code> ​持久化到硬盘中的并不是内存中的数据快照，而是<strong>将所有写命令记录到日志中</strong>。</p> <p>AOF 能做到最多丢失 1s 内的数据，甚至不丢失数据。</p> <p>Redis 提供了三种 AOF 策略 ：</p> <ul><li><p><code>appendfsync always</code></p> <p>每执行一次写命令，都对 aof 文件续写。</p></li> <li><p><code>appendfsync everysec</code>​</p> <p>每一秒进行一次 aof 文件续写，这一秒的写命令都会记录。</p></li> <li><p><code>appendfsync no</code></p> <p>并不是不开启，而是将 aof 续写的时机交给操作系统管理，操作系统开心了就续写，不开心就不续写。</p></li></ul> <p>这三种策略其实也就是控制aof缓存写入日志的时机罢了，什么？aof缓存是什么呢？往下看</p> <p>AOF文件记录的具体过程 ：先将命令写入内存，再将命令写入日志。</p> <ol><li>命令追加 ：将新执行的命令追加到 aof缓存 中</li> <li>文件写入 ：将 aof缓存 中的数据写到aof文件中
这一步需要进行系统调用，看过操作系统的都知道，系统调用需要触发函数，比如read、write，redis用的是 <font color="Blue">fsync()</font>, 这个命令怎么触发？
就是上面配置的AOF策略，always、everysec、no。</li></ol> <p>所以说，AOF的三种策略其实就是控制执行 fsync命令 的时机。</p> <p><strong>优点 ：</strong></p> <ul><li>保证数据丢失风险降到最低</li></ul> <p><strong>缺点 ：</strong></p> <ul><li>aof 文件的体积会很大，同时加载速度很慢</li></ul> <h3 id="_3-2-aof-文件的重写"><a href="#_3-2-aof-文件的重写" class="header-anchor">#</a> 3.2 AOF 文件的重写</h3> <p>随着 <code>Redis</code> ​在线上运行的时间越来越久，客户端执行的命令越来越多，<code>AOF</code> ​的文件也会越来越大。</p> <p>当我们执行 100 次 <code>set name 张三</code>​，其中 99 次都是多余的，因为想要恢复只要执行一次 <code>set name 张三</code> ​就行了。为了压缩 AOF 文件的体积，Redis 提供了 <code>AOF文件重写机制</code>​。</p> <p>有两种方式触发 AOF 的重写机制：</p> <ul><li><p>手动：执行 <code>bgrewrite</code>​，background rewrite，不会阻塞 Redis</p></li> <li><p>自动：在配置文件中进行配置</p> <div class="language-vim extra-class"><pre class="language-vim"><code>auto<span class="token operator">-</span>aof<span class="token operator">-</span>rewrite<span class="token operator">-</span>percentage <span class="token number">100</span>
auto<span class="token operator">-</span>aof<span class="token operator">-</span>rewrite<span class="token operator">-</span>min<span class="token operator">-</span>size 64mb
</code></pre></div><p>当 AOF 文件体积大于 64MB，或者比上一次重写之后体积大了 100%，会自动触发。</p> <p>如果重写过于频繁，可以考虑将 auto-aof-rewrite-percentage 设置为更大。</p></li></ul> <p>‍</p> <blockquote><p>AOF 重写机制并没有根据现有的AOF文件重写，而是是在重写时，读取当前数据库中的所有键值对，然后将每一个键值对用一条命令记录到「新的 AOF 文件」，等到全部记录完后，就将新的 AOF 文件替换掉现有的 AOF 文件。</p></blockquote> <p>为什么不使用原有的 AOF 文件呢?</p> <p>如果在原有的AOF文件基础上重新，但凡AOF文件重写过程中宕机或者失败，原有的AOF文件就被污染了，可能无法用于数据恢复。所以保留原有的AOF文件是保底策略。</p> <div class="custom-block note"><p class="custom-block-title">重写的具体过程</p> <p>重写使用到了写时复制</p> <p>写时复制 ：父进程 fork 出一个子进程，两个进程共用同一块内存区域（二者的虚拟内存虽然不相同，但是虚拟内存对应的物理内存是一样的），主进程是可以正常处理读请求的，但是如果出现写请求，且操作的数据是已经存在的，⭐操作系统就会将<strong>这个数据在父进程的物理内存</strong>复制一份交给子进程。注意，这里复制的物理内存是 修改了哪个数据就只复制这个数据的物理内存，而不是将父进程的所有物理内存都复制一份。</p> <p>Redis 设置了一个 <strong>AOF 重写缓冲区</strong>。 在重写 AOF 期间，当 Redis 执行完一个写命令之后，它会同时将这个写命令写入到 「AOF 缓冲区」和 「AOF 重写缓冲区」。</p> <p>当子进程完成AOF的重写后，会通知父进程，父进程操作<strong>AOF 重写缓冲区</strong>，将追加的数据写入AOF文件（这个步骤是父进程进行的）</p></div> <p>需要注意的是 ：RDB快照和AOF重写的过程都用到了写时复制。</p> <h2 id="_4-混合型持久化"><a href="#_4-混合型持久化" class="header-anchor">#</a> 4. 混合型持久化</h2> <p>因为 <code>RDB</code> ​虽然加载快但是存在数据丢失，<code>AOF</code> ​数据安全但是加载缓慢，<code>Redis</code> ​为了解决这个问题，带来了一个新的持久化选项——混合持久化。将 <code>RDB</code> ​文件的内容和增量的 <code>AOF</code> ​日志文件存在一起。这里的 <code>AOF</code> ​日志不再是全量 的日志，而是自持久化开始到持久化结束的这段时间发生的增量 <code>AOF</code> ​日志，通常这部分 <code>AOF</code> ​日志很小。<code>Redis</code> ​重启的时候，可以先加载 <code>RDB</code> ​的内容，然后再重放增量 <code>AOF</code> ​日志，就可以完全替代之前的 <code>AOF</code> ​全量文件重放，恢复效率因此大幅得到提升（混合型持久化最终生成的文件后缀是 <code>.aof</code>​，可以通过 <code>redis.conf</code> ​文件中 <code>aof-use-rdb-preamble yes</code> ​配置开启）。</p> <ul><li><p><strong>优点：</strong></p> <p>结合了 <code>RDB</code> ​和 <code>AOF</code> ​的优点，使得数据恢复的效率大幅提升</p></li> <li><p><strong>缺点：</strong></p> <p>兼容性不好，<code>Redis-4.x</code> ​新增，虽然最终的文件也是 <code>.aof</code> ​格式的文件，但在 <code>4.0</code> ​之前版本都不识别该 <code>aof</code> ​文件，同时由于前部分是 <code>RDB</code> ​格式，阅读性较差。</p></li></ul> <h2 id="_5-总结"><a href="#_5-总结" class="header-anchor">#</a> 5. 总结</h2> <p><img src="https://typorehwf.oss-cn-chengdu.aliyuncs.com/image-20230102132247-ww8ti4d.png" alt="image"></p></div></div>  <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/10/31, 23:05:02</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/77c4c7/" class="prev">Redis数据结构与数据类型</a></span> <span class="next"><a href="/pages/73749d/">Redis内存回收</a>→
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="3175543112@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/2382546457" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2023-2024
    <span>何 | MIT License</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.55b11924.js" defer></script><script src="/assets/js/2.73d4029d.js" defer></script><script src="/assets/js/17.353aa3a5.js" defer></script>
  </body>
</html>
